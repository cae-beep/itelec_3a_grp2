<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>MunchMate</title>

  <!-- External CSS and Scripts -->
<link rel="stylesheet" href="style1.css" />
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet" />
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@700&display=swap" rel="stylesheet" />
</head>
<body>
    <nav class="w-full flex justify-between items-center py-4 px-8 shadow-md">
        <div class="flex items-center">
            <span class="bg-green-800 text-yellow-500 text-lg px-4 py-2 rounded-full font-bold flex items-center">
                <img src="logo12.png" alt="Logo" class="w-4 h-5 mr-1"> MUNCHMATE
            </span>
        </div>    
    <div class="flex items-center space-x-8">
        <a id="discoverTab" class="text-green-800 text-lg px-4 py-2 rounded-lg hover:bg-yellow-200 cursor-pointer" href="#" onclick="showPage('discover')">DISCOVER</a>
        <a id="addRecipeTab" class="text-green-800 text-lg px-4 py-2 rounded-lg hover:bg-yellow-200 cursor-pointer" href="#" onclick="showPage('addRecipe')">ADD RECIPE</a>
        <a id="notificationsTab" class="text-green-800 text-lg px-4 py-2 rounded-lg hover:bg-yellow-200 cursor-pointer" href="#" onclick="showPage('notifications')">NOTIFICATIONS</a>
        <a id="userTab" class="text-green-800 text-lg px-4 py-2 rounded-lg hover:bg-yellow-200 cursor-pointer" href="#" onclick="showPage('user')">USER</a>
    </div>
</nav>


    <!-- Discover Section -->
    <div class="page w-full mt-8 px-8 hidden" id="discover">
<!-- Top Recipes Header -->
<div class="flex justify-between items-center mb-8">
    <h2 class="text-green-800 text-6xl font-bold mx-auto">Top Recipes</h2>
    <select id="topCategoryFilter" title="Filter by Category" class="border border-green-800 p-2 rounded" onchange="loadTopRecipes()">
        <option value="">Current Time</option>
        <option value="Breakfast">Breakfast</option>
        <option value="Lunch">Lunch</option>
        <option value="Snack">Snack</option>
        <option value="Dinner">Dinner</option>
    </select>
</div>

<!-- Top Recipes Container -->
<div id="topRecipesContainer" class="grid grid-cols-3 gap-8">
    <!-- Top Recipes will be injected here -->
</div>


        <!-- Discover Section -->
        <div class="flex justify-between items-center mb-8 mt-7">
            <h1 class="text-green-800 text-6xl font-bold mx-auto">Discover Recipes</h1>
            <select id="categoryFilter" title="Filter by Category" class="border border-green-800 p-2 rounded">
                <option value="">Current Time</option>
                <option value="Breakfast">Breakfast</option>
                <option value="Lunch">Lunch</option>
                <option value="Snack">Snack</option>
                <option value="Dinner">Dinner</option>
            </select>
        </div>

        <!-- Recipes container -->
        <div id="recipesContainer" class="grid grid-cols-3 gap-8"></div>
    </div>


<!-- Recipe Modal for Top Recipes -->
<div id="topRecipeModal" class="modal hidden fixed top-0 left-0 w-full h-full flex items-center justify-center bg-black bg-opacity-50">
    <div class="bg-white p-8 rounded-lg max-w-lg w-full">
        <button class="mt-2 bg-red-500 text-white px-4 py-2 rounded float-right" onclick="closeTopRecipeModal()">Close</button>
        <h2 id="topRecipeTitle" class="text-green-800 text-4xl font-bold mb-4"></h2>
        <img id="topRecipeImage" src="" alt="Recipe Image" class="w-full h-48 object-cover mb-4 rounded">
        <p id="topRecipeDescription" class="text-lg text-gray-800 mb-4"></p>
        <h3 class="text-xl font-bold text-green-800 mb-2">Ingredients</h3>
        <p id="topRecipeIngredients" class="text-lg text-gray-800 mb-4"></p>
        <h3 class="text-xl font-bold text-green-800 mb-2">Procedure</h3>
        <p id="topRecipeProcedure" class="text-lg text-gray-800"></p>
    </div>
</div>


    <!-- Recipe Modal for Discover Recipes -->
    <div id="recipeModal" class="modal hidden fixed top-0 left-0 w-full h-full flex items-center justify-center bg-black bg-opacity-50">
        <div class="bg-white p-8 rounded-lg max-w-lg w-full">
            <button class="mt-2 bg-gray-500 text-white px-4 py-2 rounded float-right" onclick="closeModal()">X</button>
            <h2 id="recipeTitle" class="text-green-800 text-4xl font-bold mb-4"></h2>
            <img id="recipeImage" src="" alt="Recipe Image" class="w-full h-48 object-cover mb-4 rounded">
            <p id="recipeDescription" class="text-lg text-gray-800 mb-4"></p>
            <h3 class="text-xl font-bold text-green-800 mb-2">Ingredients</h3>
            <p id="recipeIngredients" class="text-lg text-gray-800 mb-4"></p>
            <h3 class="text-xl font-bold text-green-800 mb-2">Procedure</h3>
            <p id="recipeProcedure" class="text-lg text-gray-800"></p>
        </div>
    </div>


<!-- Add Recipe Section -->
<div class="page w-full mt-8 px-8 hidden" id="addRecipe">
    <h1 class="text-green-800 text-6xl font-bold mb-8 text-center">Add Your Recipe</h1>

    <!-- Form connects to the database -->
    <form class="flex flex-col space-y-4" action="http://127.0.0.1/addRecipe.php" method="POST" enctype="multipart/form-data">
        <label for="recipeName" class="text-green-800 text-lg">Recipe Name:</label>
        <input type="text" id="recipeName" name="recipeName" class="border border-green-800 px-4 py-2" placeholder="Enter the recipe name" required />




        <label for="description" class="text-green-800 text-lg">Description:</label>
        <textarea id="description" name="description" class="border border-green-800 px-4 py-2" placeholder="Describe the recipe" required></textarea>




        <label for="ingredients" class="text-green-800 text-lg">Ingredients:</label>
        <textarea id="ingredients" name="ingredients" class="border border-green-800 px-4 py-2" placeholder="List the ingredients" required></textarea>
        <label for="procedure" class="text-green-800 text-lg">Procedure:</label>
        <textarea id="procedure" name="procedure" class="border border-green-800 px-4 py-2" placeholder="Describe the procedure" required></textarea>

        <!-- Category Dropdown -->
        <label for="category" class="text-green-800 text-lg">Category:</label>
        <select id="category" name="category" class="border border-green-800 px-4 py-2" required>
            <option value="" disabled selected>Select a category</option>
            <option value="Breakfast">Breakfast</option>
            <option value="Lunch">Lunch</option>
            <option value="Snack">Snack</option>
            <option value="Dinner">Dinner</option>
        </select>
        <label for="imageInput" class="text-green-800 text-lg">Upload Image:</label>
        <input type="file" id="imageInput" name="imageInput" class="border border-green-800 px-4 py-2" accept="image/*" required />
        <img id="imagePreview" alt="Image Preview" class="mt-4" />
        <button type="submit" class="bg-yellow-500 text-green-800 text-lg font-bold py-2 px-4 rounded-full mt-4">Submit Recipe</button>
        <input type="hidden" id="base64Image" name="base64Image">
    </form>
</div>

  <!-- Edit Recipe Section -->
  <div class="page w-full mt-8 px-8 hidden" id="editRecipe">
    <h1 class="text-green-800 text-6xl font-bold mb-8">Edit Your Recipe</h1>
    <!-- Form for editing a recipe -->
    <form class="flex flex-col space-y-4" action="http://127.0.0.1/editRecipe.php" method="POST" enctype="multipart/form-data">
        <input type="hidden" id="editRecipeId" name="recipeId">


        <label for="editRecipeName" class="text-green-800 text-lg">Recipe Name:</label>
        <input type="text" id="editRecipeName" name="recipeName" class="border border-green-800 px-4 py-2" placeholder="Enter the recipe name" required />


        <label for="editDescription" class="text-green-800 text-lg">Description:</label>
        <textarea id="editDescription" name="description" class="border border-green-800 px-4 py-2" placeholder="Describe the recipe" required></textarea>


        <label for="editIngredients" class="text-green-800 text-lg">Ingredients:</label>
        <textarea id="editIngredients" name="ingredients" class="border border-green-800 px-4 py-2" placeholder="List the ingredients" required></textarea>


        <label for="editProcedure" class="text-green-800 text-lg">Procedure:</label>
        <textarea id="editProcedure" name="procedure" class="border border-green-800 px-4 py-2" placeholder="Describe the procedure" required></textarea>


        <!-- Category Dropdown -->
        <label for="editCategory" class="text-green-800 text-lg">Category:</label>
        <select id="editCategory" name="category" class="border border-green-800 px-4 py-2" required>
            <option value="" disabled selected>Select a category</option>
            <option value="Breakfast">Breakfast</option>
            <option value="Lunch">Lunch</option>
            <option value="Snack">Snack</option>
            <option value="Dinner">Dinner</option>
        </select>


        <label for="editImageInput" class="text-green-800 text-lg">Upload Image:</label>
        <input type="file" id="editImageInput" name="imageInput" class="border border-green-800 px-4 py-2" accept="image/*" />


        <img id="editImagePreview" alt="Image Preview" class="mt-4" />
        <button type="submit" class="bg-yellow-500 text-green-800 text-lg font-bold py-2 px-4 rounded-full mt-4">Save Changes</button>
        <input type="hidden" id="editBase64Image" name="base64Image">
    </form>
</div>


<!-- JavaScript for handling image preview and base64 conversion -->
<script>
    document.getElementById('imageInput').addEventListener('change', function(event) {
        const file = event.target.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            const base64String = e.target.result;
            document.getElementById('imagePreview').src = base64String;
            document.getElementById('base64Image').value = base64String; // Save Base64 string in hidden input
        };
        if (file) {
            reader.readAsDataURL(file);
        }
    });
    
    // Show preview of the new uploaded image in the edit form
document.getElementById('editImageInput').addEventListener('change', function(event) {
    const file = event.target.files[0];
    const reader = new FileReader();
    reader.onload = function(e) {
        // Display the selected image in the preview element
        document.getElementById('editImagePreview').src = e.target.result;
    };
    if (file) {
        reader.readAsDataURL(file);
    }
});

</script>


<!-- Notifications Section -->
<div class="page w-full mt-8 px-8 hidden" id="notifications">
    <h1 class="text-green-800 text-6xl font-bold mb-8 text-center">Notifications</h1>
    <div id="notificationsContent" class="notifications-container">
        <!-- Notifications will be injected here dynamically -->
    </div>
</div>

<!-- User Profile Section -->
<div class="page w-full mt-8 px-8 hidden" id="user">
    <div class="text-center mb-8 relative">
        <h1 class="text-green-800 text-6xl font-bold">User Profile</h1>
        
        <!-- Settings button to open modal, positioned to the upper right below the heading -->
        <button class="bg-transparent border-none cursor-pointer absolute right-0 top-full mt-2 text-4xl" id="settingsButton">
            <span class="large-icon" role="img" aria-label="Settings Icon">⚙️</span>
        </button>
    </div>


<!-- Main Content Container -->
<div id="content" class="mt-8 px-8">
    <div id="userProfile" class="flex justify-center items-center space-x-6">
        <div class="relative text-center profile-container">
            <span class="text-6xl">👤</span> <!-- User emoji -->
            <h2 id="username" class="text-3xl mt-4">User Name</h2>
            
            <!-- Badge Container (Initially hidden until JavaScript makes it visible based on conditions) -->
            <div class="badge-container mt-4 hidden" id="badgeContainer">
                <!-- Bronze Badge for 5 Likes -->
                <div id="bronzeBadge" class="badge hidden">
                    <span class="bronze-badge">🥉</span>
                    <span class="badge-label">Kitchen Newbie (5 Likes)</span>
                </div>

                <!-- Silver Badge for 10 Likes -->
                <div id="silverBadge" class="badge hidden">
                    <span class="silver-badge">🥈</span>
                    <span class="badge-label">Recipe Rookie (10 Likes)</span>
                </div>

                <!-- Gold Badge for 20 Likes -->
                <div id="goldBadge" class="badge hidden">
                    <span class="gold-badge">🥇</span>
                    <span class="badge-label">Home Chef Hero (20 Likes)</span>
                </div>
            </div>

            <!-- Total Likes Count -->
            <div class="flex justify-center items-center space-x-6 mt-2">
                <span class="ml-12 text-green-800" id="totalLikes">Likes: 0</span>
            </div>

            <div class="flex justify-start mt-6 space-x-4">
                <button class="bg-yellow-500 text-white px-4 py-2 rounded-lg hover:bg-yellow-500" onclick="showUserRecipes()">My Recipes</button>
                <button class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-500" onclick="showLikedRecipes()">Likes</button>
            </div>
        </div>
    </div>
</div>


<!-- Dynamic User Recipes and Liked Recipes Sections -->
<div id="userContent" class="mt-8 hidden">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-3xl text-green-700 font-bold" id="userSectionTitle"></h2>
    </div>
    <div id="userRecipes" class="grid grid-cols-2 gap-4">
        <!-- Dynamically displayed user recipes or liked recipes will appear here -->
    </div>
</div>




    </div>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="modal hidden fixed top-0 left-0 w-full h-full flex items-center justify-center bg-black bg-opacity-50">
    <div class="bg-white p-8 rounded-lg w-96 relative">
        <!-- Close button -->
        <button class="absolute top-4 right-4 text-gray-500 hover:text-gray-800" onclick="closeSettings()">
            &times; <!-- Close icon -->
        </button>
        <h2 class="text-green-800 text-4xl font-bold mb-6 text-center">Settings</h2>
        <ul class="space-y-4">
            <li><button class="block w-full text-left text-xl bg-gray-100 px-4 py-2 rounded-lg hover:bg-gray-200" onclick="editProfile()">Edit Profile</button></li>
            <li><button class="block w-full text-left text-xl bg-gray-100 px-4 py-2 rounded-lg hover:bg-gray-200" onclick="showAboutUs()">About Us</button></li>
            <li><button class="block w-full text-left text-xl bg-gray-100 px-4 py-2 rounded-lg hover:bg-gray-200" onclick="logout()">Logout</button></li>
        </ul>
    </div>
</div>

<!-- About Us Modal -->
<div id="aboutUsModal" class="modal hidden fixed top-0 left-0 w-full h-full flex items-center justify-center bg-black bg-opacity-50">
    <div class="bg-white p-8 rounded-lg max-w-lg w-full relative">
        <button class="absolute top-4 right-4 text-gray-500 hover:text-gray-800" onclick="closeAboutUs()">
            &times;
        </button>
        <h2 class="text-green-800 text-4xl font-bold mb-4 text-center">About Us</h2>
        <p class="text-lg text-gray-800 mb-6">
            Welcome to MunchMate—your go-to recipe app for sharing, discovering, and connecting through food! Whether you’re a seasoned chef or a kitchen newbie, MunchMate lets you upload your favorite recipes, explore exciting new dishes, and connect with a community of food lovers. Share your creations, swap cooking tips, and build your personal recipe collection. With MunchMate, every meal is an adventure waiting to happen! Dive in, cook up, and let’s make every bite memorable together.
        </p>
        <h3 class="text-xl font-bold text-green-800">Contact Information</h3>
        <p class="text-gray-800 mb-2">Email: munchmate@gmail.com</p>
        <p class="text-gray-800 mb-2">Phone: +1 (555) 123-4567</p>
        <p class="text-gray-800">Address: 143 Cornelia street Ave, Food City, USA</p>
    </div>
</div>

<!-- Recipe Modal -->
<div id="recipeModal" class="modal hidden fixed top-0 left-0 w-full h-full flex items-center justify-center bg-black bg-opacity-50 z-50">
    <div class="bg-white p-8 rounded-lg max-w-lg w-full relative z-60">
        <!-- Close button with proper positioning and z-index -->
        <button class="absolute top-4 right-4 bg-red-500 text-white px-4 py-2 rounded z-70 close-modal-button" onclick="closeModal()">Close</button>
        <h2 id="recipeTitle" class="text-green-800 text-4xl font-bold mb-4"></h2>
        <img id="recipeImage" src="" alt="Recipe Image" class="w-full h-48 object-cover mb-4 rounded hidden">
        <p id="recipeDescription" class="text-lg text-gray-800 mb-4"></p>
        <h3 class="text-xl font-bold text-green-800 mb-2">Ingredients</h3>
        <p id="recipeIngredients" class="text-lg text-gray-800 mb-4"></p>
        <h3 class="text-xl font-bold text-green-800 mb-2">Procedure</h3>
        <p id="recipeProcedure" class="text-lg text-gray-800"></p>
    </div>
</div>
<script>
    // Fetch the logged-in user's name
function fetchUsername() {
    fetch('getUserInfo.php')  
        .then(response => response.json())
        .then(data => {
            if (data.user_name) {
                document.getElementById('username').textContent = data.user_name;
            } else {
                console.error(data.error); // Log the error message from getUserInfo.php
            }
        })
        .catch(error => console.error('Error fetching username:', error));
}

// Call fetchUsername when the page loads
window.onload = fetchUsername;

    // Function to handle logout
    function logout() {
    window.location.href = 'logout.php';
}
    // Toggle settings modal
    document.getElementById('settingsButton').addEventListener('click', function() {
        document.getElementById('settingsModal').classList.remove('hidden');
    });

    function closeSettings() {
        document.getElementById('settingsModal').classList.add('hidden');
    }
    function showAboutUs() {
        document.getElementById('settingsModal').classList.add('hidden');
        document.getElementById('aboutUsModal').classList.remove('hidden');
    }
    function closeAboutUs() {
        document.getElementById('aboutUsModal').classList.add('hidden');
    }
    function showUserRecipes() {
        document.getElementById('userSectionTitle').innerText = "My Recipes";
        document.getElementById('userContent').classList.remove('hidden');
    }
    function showLikedRecipes() {
        document.getElementById('userSectionTitle').innerText = "Liked Recipes";
        document.getElementById('userContent').classList.remove('hidden');
    }
    // Function to close the recipe modal
    function closeModal() {
        const recipeModal = document.getElementById('recipeModal');
        if (recipeModal) {
            recipeModal.classList.add('hidden');
        }
    

// Highlight the active tab
document.querySelectorAll("nav a").forEach(tab => tab.classList.remove("bg-yellow-400", "text-white"));
document.getElementById(`${pageId}Tab`).classList.add("bg-yellow-400", "text-white");


// Call loadNotifications if the Notifications page is shown
if (pageId === 'notifications') {
    console.log("Loading notifications...");
    loadNotifications();
}
}

</script>

<!-- JavaScript -->
<script>
    // Cookie Helper Functions
    function getLikedRecipes() {
        const likedRecipes = document.cookie.replace(/(?:(?:^|.*;\s*)likedRecipes\s*\=\s*([^;]*).*$)|^.*$/, "$1");
        return likedRecipes ? JSON.parse(likedRecipes) : [];
    }

    function saveLikedRecipes(likedRecipes) {
        document.cookie = "likedRecipes=" + JSON.stringify(likedRecipes) + "; path=/; max-age=" + (60 * 60 * 24 * 30);
    }

        // Function to check if the user is logged in
        function isUserLoggedIn() {
        return !!document.cookie.split(';').find(cookie => cookie.trim().startsWith('user_id='));
    }

    // Get current category based on time
    function getCurrentCategory() {
        const hours = new Date().getHours();
        if (hours >= 4 && hours < 11) return 'Breakfast';
        if (hours >= 11 && hours < 16) return 'Lunch';
        if (hours >= 16 && hours < 20) return 'Snack';
        return 'Dinner';
    }

function loadRecipes() {
    const selectedCategory = document.getElementById('categoryFilter').value || getCurrentCategory();
    fetch('http://127.0.0.1/getRecipe.php')
        .then(response => response.json())
        .then(data => {
            const recipesContainer = document.getElementById('recipesContainer');
            recipesContainer.innerHTML = '';
            const likedRecipes = getLikedRecipes();
            const isLoggedIn = isUserLoggedIn();
            const filteredData = data.filter(recipe => recipe.category === selectedCategory);
            filteredData.forEach(recipe => {
                const isLiked = likedRecipes.includes(recipe.recipeId);
                const recipeCard = `
                    <!-- Recipe Card -->
<div class="recipe-card bg-white text-center rounded-lg p-6 flex flex-col items-center shadow-md border border-green-800">
    <img src="${recipe.img}" class="w-full h-48 object-cover cursor-pointer" alt="${recipe.name}" onclick="showRecipe('${recipe.name}', '${recipe.desc}', '${recipe.ingredients}', '${recipe.procedure}', '${recipe.img}')"/>
    <h2 class="text-green-800 text-xl font-bold mt-4">${recipe.name}</h2>
    <div class="flex justify-center items-center space-x-4 mt-2">
        <button class="like-button bg-green-800 text-white px-4 py-2 rounded" data-recipe-id="${recipe.recipeId}" onclick="toggleLike(${recipe.recipeId})">
            ${isLiked ? 'Unlike' : 'Like'}
        </button>
        <span class="like-count text-green-800 mt-2" id="like-count-${recipe.recipeId}">${recipe.likeCount} Likes</span>
        <!-- Comment Section -->
        <button class="comment-btn text-blue-500 text-lg" onclick="openCommentModal('${recipe.recipeId}')">💬 Comment</button>
    </div>
</div>

<!-- Comment Modal for each recipe -->
<div id="commentModal-${recipe.recipeId}" class="modal hidden fixed top-0 left-0 w-full h-full flex items-center justify-center bg-black bg-opacity-50">
    <div class="bg-white p-8 rounded-lg max-w-lg w-full relative">
        <button class="absolute top-4 right-4 text-gray-500 hover:text-gray-800" onclick="closeCommentModal('${recipe.recipeId}')">X</button>
        <h3 class="text-green-800 text-3xl font-bold mb-4">Comments for ${recipe.name}</h3>
   
        <!-- Existing comments will be displayed here -->
        <div id="all-comments-${recipe.recipeId}" class="mt-4">
            <!-- All comments will be appended here -->
        </div>
   
        <!-- Comment input -->
        <div id="commentInput-${recipe.recipeId}" class="mt-4">
            <textarea placeholder="Add a comment" class="border border-green-800 w-full px-4 py-2"></textarea>
            <button class="bg-yellow-500 text-green-800 text-lg font-bold py-2 px-4 rounded-full mt-2 mx-auto block" onclick="addComment(${recipe.recipeId})">Submit</button>
        </div>
    </div>
</div>
                `;
                recipesContainer.innerHTML += recipeCard;
            });
            if (!filteredData.length) {
                recipesContainer.innerHTML = `<p class="text-red-600">No recipes available for ${selectedCategory}.</p>`;
            }
        })
        .catch(error => console.error('Error fetching recipes:', error));
}

// Toggle like/unlike functionality
function toggleLike(recipeId) {
const likedRecipes = getLikedRecipes();
const isLiked = likedRecipes.includes(recipeId);
const action = isLiked ? 'unlike' : 'like';

// Log the action being sent
console.log(`Sending action: ${action} for recipeId: ${recipeId}`);


// Optimistically update UI state
const likeButton = document.querySelector(`.like-button[data-recipe-id="${recipeId}"]`);
const likeCountElement = document.getElementById(`like-count-${recipeId}`);
let currentLikeCount = parseInt(likeCountElement.innerText) || 0;

// Toggle button text and count optimistically
likeButton.innerText = isLiked ? 'Like' : 'Unlike';
likeCountElement.innerText = `${isLiked ? currentLikeCount - 1 : currentLikeCount + 1} Likes`;

// Update likedRecipes cookie
if (isLiked) {
    likedRecipes.splice(likedRecipes.indexOf(recipeId), 1);
} else {
    likedRecipes.push(recipeId);
}
saveLikedRecipes(likedRecipes);

// Send request to server
fetch('http://127.0.0.1/likeRecipe.php', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ action, recipeId })
})
.then(response => response.json())
.then(data => {
    if (!data.success) {
        // Revert the optimistic update on failure
        likeButton.innerText = isLiked ? 'Unlike' : 'Like';
        likeCountElement.innerText = `${currentLikeCount} Likes`; // Restore original count
        alert(`Error: ${data.message}`);
    } else {
        // Update UI with the confirmed like count from the server
        likeCountElement.innerText = `${data.likeCount} Likes`;
    }
})
.catch(error => {
    console.error('Error toggling like:', error);
    // Revert optimistic update on error
    likeButton.innerText = isLiked ? 'Unlike' : 'Like';
    likeCountElement.innerText = `${currentLikeCount} Likes`;
    alert('There was an error. Please try again.');
});
}

// Function to open the comment modal for a specific recipe
function openCommentModal(recipeId) {
    const modal = document.getElementById(`commentModal-${recipeId}`);
    if (modal) {
        modal.classList.remove('hidden'); // Make the modal visible
        loadComments(recipeId); // Load and display existing comments
    } else {
        console.error(`Could not find modal for recipeId: ${recipeId}`);
    }
}

// Function to close the comment modal
function closeCommentModal(recipeId) {
    const modal = document.getElementById(`commentModal-${recipeId}`);
    modal.classList.add('hidden'); // Hide the modal
}

// Function to submit a new comment
function addComment(recipeId) {
    const commentInput = document.querySelector(`#commentInput-${recipeId} textarea`);
    const comment = commentInput.value.trim();
    if (comment) {
        fetch('http://127.0.0.1/addComment.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ recipeId, comment })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const allCommentsDiv = document.getElementById(`all-comments-${recipeId}`);
                const newComment = document.createElement('div');
                newComment.classList.add('comment');
                newComment.innerText = comment; // Display the new comment
                allCommentsDiv.appendChild(newComment);

                // Clear the input field
                commentInput.value = '';
            } else {
                alert(`Error: ${data.message}`);
            }
        })
        .catch(error => {
            console.error('Error adding comment:', error);
        });
    } else {
        alert("Please enter a comment before submitting.");
    }
}

function loadComments(recipeId) {
    fetch(`http://127.0.0.1/getRecipe.php?recipeId=${recipeId}`)
        .then(response => response.json())
        .then(data => {
            const recipe = data.find(r => parseInt(r.recipeId) === parseInt(recipeId));
            const commentsContainer = document.getElementById(`all-comments-${recipeId}`);
            commentsContainer.innerHTML = ''; // Clear any existing comments

            if (recipe && recipe.comments && recipe.comments.length > 0) {
                recipe.comments.forEach(comment => {
                    const commentElement = document.createElement('div');
                    commentElement.classList.add('comment');
                    commentElement.textContent = comment; // Each comment is already formatted as "username: comment"
                    commentsContainer.appendChild(commentElement);
                });
            } else {
                const noCommentsMessage = document.createElement('p');
                noCommentsMessage.textContent = "No comments yet.";
                commentsContainer.appendChild(noCommentsMessage);
            }
        })
        .catch(error => console.error('Error loading comments:', error));
}


// Add Comment function (if user wants to add a new comment)
function addComment(recipeId) {
    const commentInput = document.querySelector(`#commentInput-${recipeId} textarea`);
    const comment = commentInput.value.trim();
    if (comment) {
        fetch('http://127.0.0.1/addComment.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ recipeId, comment })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // After adding a new comment, reload comments
                loadComments(recipeId);
                commentInput.value = ''; // Clear the input field
            } else {
                alert(`Error: ${data.message}`);
            }
        })
        .catch(error => console.error('Error adding comment:', error));
    } else {
        alert("Please enter a comment before submitting.");
    }
}


// Load top recipes based on the selected category
function loadTopRecipes() {
    const selectedCategory = document.getElementById('topCategoryFilter').value || getCurrentCategory();
    fetch(`http://127.0.0.1/getRecipe.php?top=true&category=${selectedCategory}`)
        .then(response => response.json())
        .then(data => {
            const topRecipesContainer = document.getElementById('topRecipesContainer');
            topRecipesContainer.innerHTML = ''; // Clear existing content

            // Loop through each category and its top recipes
            for (const [category, recipes] of Object.entries(data)) {
                const filteredTopRecipes = recipes.filter(recipe => recipe.likeCount > 0);  // Ensure only liked recipes are shown
           
                // Show only the top 5 recipes from the filtered list
                filteredTopRecipes.slice(0, 5).forEach(recipe => {
                    const recipeCard = `
                        <div class="recipe-card bg-white text-center rounded-lg p-6 flex flex-col items-center shadow-md border border-green-800"
                            onclick="showRecipe('${recipe.name}', '${recipe.desc}', '${recipe.ingredients}', '${recipe.procedure}', '${recipe.img}')">
                            <img src="${recipe.img}" class="w-full h-48 object-cover cursor-pointer" alt="${recipe.name}" />
                            <h3 class="text-green-800 text-xl font-bold mt-2">${recipe.name}</h3>
                            <span class="like-count text-green-800 mt-2">${recipe.likeCount} Likes</span>
                        </div>
                    `;
                    topRecipesContainer.innerHTML += recipeCard; // Add recipe card to the container
                });
            }
        })
        .catch(error => console.error('Error fetching top recipes:', error));
}


// Function to get current category based on time
function getCurrentCategory() {
    const hours = new Date().getHours();
    if (hours >= 4 && hours < 11) return 'Breakfast';
    if (hours >= 11 && hours < 16) return 'Lunch';
    if (hours >= 16 && hours < 20) return 'Snack';
    return 'Dinner';
}


// Function to load notifications
function loadNotifications() {
fetch('getNotifications.php')
    .then(response => response.json())
    .then(data => {
        console.log(data); // Log the response to ensure comments are included properly
        const notificationsContainer = document.getElementById('notificationsContent');
        notificationsContainer.innerHTML = ''; // Clear existing notifications

        if (data.length === 0) {
            notificationsContainer.innerHTML = '<p class="text-gray-600">You have no new notifications.</p>';
        } else {
            data.forEach(notification => {
                // Determine the CSS class based on the read status
                const notificationClass = notification.notification_status === 1 ? 'read' : 'unread highlight';
                const notificationHTML = `
                    <div class="notification ${notificationClass} p-4 mb-4 rounded-lg shadow-md cursor-pointer bg-white hover:bg-green-50"
                         onclick="markNotificationAsRead(${notification.notificationId})">
                        <span>${notification.message}</span>
                    </div>
                `;
                notificationsContainer.innerHTML += notificationHTML;
            });
        }
    })
    .catch(error => console.error('Error loading notifications:', error));
}

// Function to mark a notification as read
function markNotificationAsRead(notificationId) {
fetch('markNotifAsRead.php', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ notificationId })
})
.then(response => response.json())
.then(data => {
    if (data.success) {
        loadNotifications(); // Reload notifications to update the status
    } else {
        console.error('Error:', data.message);
    }
})
.catch(error => console.error('Error marking notification as read:', error));
}

// Function to show user's recipes
function showUserRecipes() {
    fetch('getUserRecipe.php') // Fetch user-created recipes
        .then(response => response.json())
        .then(data => {
            const userRecipesContainer = document.getElementById('userRecipes');
            userRecipesContainer.innerHTML = ''; // Clear existing content
            if (data.error) {
                userRecipesContainer.innerHTML = `<p class="text-red-600">${data.error}</p>`;
                return;
            }

            // Display each recipe as a clickable list item with a kebab menu
            if (data.length > 0) {
                data.forEach(recipe => {
                    const recipeItem = `
                        <div class="recipe-item flex justify-between items-center text-green-800 text-lg font-bold mb-4 border-b border-green-800 p-2 relative" data-recipe-id="${recipe.recipeId}">
                            <div onclick="showRecipe('${recipe.name}', '${recipe.desc}', '${recipe.ingredients}', '${recipe.procedure}', '${recipe.img || 'null'}')" class="flex-1 cursor-pointer">
                                ${recipe.name} - ${recipe.category}
                            </div>
                            <!-- Kebab Menu -->
                            <div class="relative">
                                <button class="kebab-menu-button" onclick="toggleKebabMenu(event, '${recipe.recipeId}')">
                                    &#x22EE; <!-- Unicode for vertical ellipsis (kebab menu) -->
                                </button>
                                <div id="kebabMenu-${recipe.recipeId}" class="kebab-menu hidden absolute right-0 bg-white border border-gray-300 shadow-lg rounded-lg mt-2">
                                    <button class="block w-full text-left px-4 py-2 hover:bg-gray-200" onclick="editRecipe('${recipe.recipeId}')">Edit</button>
                                    <button class="block w-full text-left px-4 py-2 hover:bg-red-200 text-red-600" onclick="deleteRecipe('${recipe.recipeId}')">Delete</button>
                                </div>
                             </div>
                        </div>
                    `;
                    userRecipesContainer.innerHTML += recipeItem;
                });
            } else {
                userRecipesContainer.innerHTML = `<p class="text-gray-600">You have not posted any recipes yet.</p>`;
            }

            // Show the user content section and update the title
            document.getElementById('userContent').classList.remove('hidden');
            document.getElementById('userSectionTitle').innerText = "My Recipes";
        })
        .catch(error => console.error('Error fetching user recipes:', error));
}

// Function to toggle kebab menu visibility
function toggleKebabMenu(event, recipeId) {
    event.stopPropagation(); // Prevent the recipe card from being clicked when clicking the kebab menu
    const kebabMenu = document.getElementById(`kebabMenu-${recipeId}`);
    if (kebabMenu.classList.contains('hidden')) {
        kebabMenu.classList.remove('hidden');
    } else {
        kebabMenu.classList.add('hidden');
    }
    // Close other kebab menus if any are open
    document.querySelectorAll('.kebab-menu').forEach(menu => {
        if (menu.id !== `kebabMenu-${recipeId}`) {
            menu.classList.add('hidden');
        }
    });
}


function editRecipe(recipeId) {
            fetch(`getSpecificRecipe.php?recipeId=${recipeId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const recipe = data.recipe;
                        document.getElementById('editRecipeId').value = recipe.recipeId;
                        document.getElementById('editRecipeName').value = recipe.name;
                        document.getElementById('editDescription').value = recipe.desc;
                        document.getElementById('editIngredients').value = recipe.ingredients;
                        document.getElementById('editProcedure').value = recipe.procedure;
                        document.getElementById('editCategory').value = recipe.category;


                        if (recipe.img) {
                            document.getElementById('editImagePreview').src = recipe.img;
                        }


                        // Show edit recipe page
                        showPage('editRecipe');
                    } else {
                        console.error('Error fetching recipe details:', data.message);
                    }
                })
                .catch(error => console.error('Error fetching recipe:', error));
        }
        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => page.classList.add('hidden'));
            // Show the selected page
            const pageElement = document.getElementById(pageId);
            if (pageElement) {
                pageElement.classList.remove('hidden');
            }
        }
        // Add a callback to reload recipes after saving edits
document.querySelector('form[action="http://127.0.0.1/editRecipe.php"]').addEventListener('submit', function(event) {
    event.preventDefault();

    // Assuming the form submission is AJAX or you handle the response
    fetch('editRecipe.php', {
        method: 'POST',
        body: new FormData(this)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Recipe updated successfully!');
            // Reload the recipes list to update the UI
            loadRecipes();
            loadTopRecipes();
            // Optionally, navigate back to the discover or user page
            showPage('discover');
        } else {
            alert(`Error: ${data.message}`);
        }
    })
    .catch(error => console.error('Error editing recipe:', error));
});
function showRecipe(recipeId) {
    // Fetch the latest recipe data from the server
    fetch(`getSpecificRecipe.php?recipeId=${recipeId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const recipe = data.recipe;
                document.getElementById('recipeTitle').innerText = recipe.name;
                document.getElementById('recipeDescription').innerText = recipe.desc;
                document.getElementById('recipeIngredients').innerText = recipe.ingredients;
                document.getElementById('recipeProcedure').innerText = recipe.procedure;
                
                const recipeImage = document.getElementById('recipeImage');
                if (recipe.img && recipe.img !== 'null') {
                    recipeImage.src = recipe.img; // Set provided image source
                    recipeImage.classList.remove('hidden'); // Show the image
                } else {
                    recipeImage.src = 'default-image.png'; // Set a default image if none is provided
                    recipeImage.classList.remove('hidden'); // Ensure the image element is visible
                }

                // Show the modal
                document.getElementById('recipeModal').classList.remove('hidden');
            } else {
                console.error('Error fetching recipe details:', data.message);
                alert('Unable to load recipe details.');
            }
        })
        .catch(error => console.error('Error loading recipe:', error));
}


// Function to handle delete recipe action
function deleteRecipe(recipeId) {
    if (confirm("Are you sure you want to delete this recipe?")) {
        // Send delete request to server
        fetch(`deleteRecipe.php?recipeId=${recipeId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Recipe deleted successfully.');
                // Remove the deleted recipe from the UI without reloading all recipes
                const recipeElement = document.querySelector(`.recipe-item[data-recipe-id="${recipeId}"]`);
                if (recipeElement) {
                    recipeElement.remove(); // Remove the deleted recipe from the UI
                }
            } else {
                alert(`Error: ${data.message}`);
            }
        })
        .catch(error => {
            console.error('Error deleting recipe:', error);
        });
    }
}

// Close all kebab menus if the user clicks outside
document.addEventListener('click', () => {
    document.querySelectorAll('.kebab-menu').forEach(menu => {
        menu.classList.add('hidden');
    });
});

// Function to show liked recipes of the user as a list without images
function showLikedRecipes() {
    fetch('getLikedRecipes.php') // Fetch liked recipes
        .then(response => response.json())
        .then(data => {
            const likedRecipesContainer = document.getElementById('userRecipes');
            likedRecipesContainer.innerHTML = ''; // Clear existing content

            if (data.error) {
                likedRecipesContainer.innerHTML = `<p class="text-red-600">${data.error}</p>`;
                return;
            }

            // Display each liked recipe as a clickable list item
            if (data.length > 0) {
                data.forEach(recipe => {
                    const recipeItem = `
                        <div class="recipe-item cursor-pointer text-green-800 text-lg font-bold mb-4 border-b border-green-800 p-2"
                            onclick="showRecipe('${recipe.name}', '${recipe.desc}', '${recipe.ingredients}', '${recipe.procedure}', '${recipe.img || 'null'}')">
                            ${recipe.name} - ${recipe.category}
                        </div>
                    `;
                    likedRecipesContainer.innerHTML += recipeItem;
                });
            } else {
                likedRecipesContainer.innerHTML = `<p class="text-gray-600">You have not liked any recipes yet.</p>`;
            }

            // Show the user content section and update the title
            document.getElementById('userContent').classList.remove('hidden');
            document.getElementById('userSectionTitle').innerText = "Liked Recipes";
        })
        .catch(error => console.error('Error fetching liked recipes:', error));
}
function showRecipe(name, description, ingredients, procedure, img) {
document.getElementById('recipeTitle').innerText = name;
document.getElementById('recipeDescription').innerText = description;
document.getElementById('recipeIngredients').innerText = ingredients;
document.getElementById('recipeProcedure').innerText = procedure;
const recipeImage = document.getElementById('recipeImage');


// Check if img has a valid URL or base64 data
if (img && img !== 'null') {
    recipeImage.src = img; // Set provided image source
    recipeImage.classList.remove('hidden'); // Show the image
} else {
    recipeImage.src = 'default-image.png'; // Set a default image if none is provided
    recipeImage.classList.remove('hidden'); // Ensure the image element is visible
}


// Show the modal
document.getElementById('recipeModal').classList.remove('hidden');
}



// Function to close the recipe modal
function closeModal() {
    const modal = document.getElementById('recipeModal');
    if (modal) {
        modal.classList.add('hidden');
    }
}


// Function to fetch the total likes of the logged-in user and update badges
function fetchTotalLikes() {
    fetch('getTotalLikes.php')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.total_likes !== undefined) {
                const totalLikes = data.total_likes;
                document.getElementById('totalLikes').textContent = `Likes: ${totalLikes}`;

                // Show badges based on the total likes
                const badgeContainer = document.getElementById('badgeContainer');
                const bronzeBadge = document.getElementById('bronzeBadge');
                const silverBadge = document.getElementById('silverBadge');
                const goldBadge = document.getElementById('goldBadge');

                // Reset badge visibility
                bronzeBadge.classList.add('hidden');
                silverBadge.classList.add('hidden');
                goldBadge.classList.add('hidden');
                badgeContainer.classList.add('hidden');

                // Determine which badge to show based on likes
                if (totalLikes >= 5) {
                    badgeContainer.classList.remove('hidden');
                    if (totalLikes >= 20) {
                        goldBadge.classList.remove('hidden');
                    } else if (totalLikes >= 10) {
                        silverBadge.classList.remove('hidden');
                    } else if (totalLikes >= 5) {
                        bronzeBadge.classList.remove('hidden');
                    }
                }
            } else {
                console.error('Error fetching total likes:', data.message);
            }
        })
        .catch(error => console.error('Error fetching total likes:', error));
}


// Initialize event listeners once DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    // Event listeners to close modal on button click or outside modal content
    document.querySelectorAll('.modal .close-modal-button').forEach(button => {
        button.addEventListener('click', () => closeModal());
    });

    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', event => {
            if (event.target === modal) {
                modal.classList.add('hidden');
            }
        });
    });

    document.getElementById('categoryFilter').addEventListener('change', loadRecipes);

});


// Load user data and recipes when the page loads
window.onload = function () {
    fetchUsername();
    fetchTotalLikes();
    showUserRecipes();
    loadTopRecipes();
    loadRecipes();
    showPage('discover');
    loadNotifications();
};


// Event listeners for My Recipes and Liked Recipes buttons
document.getElementById('myRecipesButton').addEventListener('click', showUserRecipes);
document.getElementById('likedRecipesButton').addEventListener('click', showLikedRecipes);


    // Load notifications on page load
    document.addEventListener('DOMContentLoaded', loadNotifications);




</script>




</body>
</html>








